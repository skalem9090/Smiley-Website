{% extends 'base.html' %}

{% block title %}Edit Post - Smileys Blog{% endblock %}

{% block content %}
  <section class="container">
    <div class="card">
      <h2>Edit Post</h2>
      <form method="post" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div style="margin-bottom:0.6rem">
          <label>{{ form.title.label }}</label>
          {{ form.title(class='form-control') }}
        </div>
        <div style="margin-bottom:0.6rem">
          <label>{{ form.category.label }}</label>
          {{ form.category(class='form-control') }}
        </div>
        <div style="margin-bottom:0.6rem">
          <label>{{ form.tags.label }} (comma separated)</label>
          {{ form.tags(class='form-control') }}
        </div>
        
        <div style="margin-bottom:0.6rem">
          <label>{{ form.images.label }}</label>
          {{ form.images(class='form-control', multiple=true, accept='image/*') }}
          <small class="form-help">Upload additional images for your post (JPEG, PNG, GIF supported)</small>
        </div>
        
        <div style="margin-bottom:0.6rem">
          <label>{{ form.summary.label }}</label>
          {{ form.summary(class='form-control', rows=3, placeholder='Optional summary or excerpt. If left blank, one will be generated automatically.') }}
          <small class="form-help">{{ form.summary.description }}</small>
        </div>
        
        <div class="form-row" style="margin-bottom:0.6rem">
          <div>
            <label>{{ form.status.label }}</label>
            {{ form.status(class='form-control', id='status-select') }}
          </div>
          <div id="scheduled-time-field" style="display: none;">
            <label>{{ form.scheduled_time.label }}</label>
            {{ form.scheduled_time(class='form-control') }}
            <small class="form-help">{{ form.scheduled_time.description }}</small>
          </div>
        </div>

        <div class="editor-split">
          <div class="editor-pane">
            <label>{{ form.content.label }}</label>
            {{ form.content(id='editor', class='form-control', rows=12) }}
            <div class="form-actions" style="margin-top:0.6rem">
              <button class="btn btn-primary" type="submit" id="submit-btn">Update Post</button>
              <a class="btn" href="{{ url_for('dashboard') }}">Cancel</a>
            </div>
          </div>

          <aside class="preview-pane" aria-live="polite">
            <div id="preview" class="post-article">
              <header>
                <h2 class="muted">Live preview</h2>
              </header>
              <div class="post-content">Start typing to see a live previewâ€¦</div>
            </div>
          </aside>
        </div>
      </form>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
  (function(){
    var editor = document.getElementById('editor');
    var preview = document.getElementById('preview').querySelector('.post-content');
    var statusSelect = document.getElementById('status-select');
    var scheduledTimeField = document.getElementById('scheduled-time-field');
    var submitBtn = document.getElementById('submit-btn');
    
    // Handle status selection changes
    function updateStatusUI() {
      var status = statusSelect.value;
      
      // Show/hide scheduled time field
      if (status === 'scheduled') {
        scheduledTimeField.style.display = 'block';
      } else {
        scheduledTimeField.style.display = 'none';
      }
      
      // Update submit button text
      var buttonText = {
        'draft': 'Save as Draft',
        'published': 'Publish Now',
        'scheduled': 'Schedule Post'
      };
      submitBtn.textContent = buttonText[status] || 'Update Post';
    }
    
    // Listen for status changes
    statusSelect.addEventListener('change', updateStatusUI);
    
    // Initialize status UI
    updateStatusUI();
    
    // Simple toolbar for basic formatting
    function createToolbar() {
      var toolbar = document.createElement('div');
      toolbar.className = 'editor-toolbar';
      toolbar.innerHTML = `
        <button type="button" onclick="formatText('bold')" title="Bold"><b>B</b></button>
        <button type="button" onclick="formatText('italic')" title="Italic"><i>I</i></button>
        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">â€¢ List</button>
        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
        <button type="button" onclick="insertLink()" title="Insert Link">ðŸ”—</button>
        <button type="button" onclick="formatText('formatBlock', 'h2')" title="Heading">H2</button>
        <button type="button" onclick="formatText('formatBlock', 'h3')" title="Subheading">H3</button>
      `;
      return toolbar;
    }
    
    // Make editor contenteditable with basic formatting
    function initEditor() {
      // Insert toolbar before editor
      var toolbar = createToolbar();
      editor.parentNode.insertBefore(toolbar, editor);
      
      // Convert textarea to contenteditable div
      var editorDiv = document.createElement('div');
      editorDiv.id = 'editor-content';
      editorDiv.className = 'form-control editor-content';
      editorDiv.contentEditable = true;
      editorDiv.innerHTML = editor.value || '<p>Start writing your post...</p>';
      
      // Replace textarea with contenteditable div
      editor.style.display = 'none';
      editor.parentNode.insertBefore(editorDiv, editor.nextSibling);
      
      // Update preview and hidden textarea on input
      function updateContent() {
        var content = editorDiv.innerHTML;
        editor.value = content;
        preview.innerHTML = content;
      }
      
      editorDiv.addEventListener('input', updateContent);
      editorDiv.addEventListener('paste', function(e) {
        setTimeout(updateContent, 10); // Allow paste to complete
      });
      
      // Initial preview update
      updateContent();
      
      // Focus the editor
      editorDiv.focus();
    }
    
    // Global formatting functions
    window.formatText = function(command, value) {
      document.execCommand(command, false, value);
      document.getElementById('editor-content').focus();
    };
    
    window.insertLink = function() {
      var url = prompt('Enter URL:');
      if (url) {
        document.execCommand('createLink', false, url);
        document.getElementById('editor-content').focus();
      }
    };
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initEditor);
    } else {
      initEditor();
    }
  })();
  </script>
{% endblock %}
