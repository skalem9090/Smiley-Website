{% extends "base.html" %}

{% block title %}Newsletter Digest Preview{% endblock %}

{% block content %}
<div class="digest-preview">
    <div class="preview-header">
        <h1>Newsletter Digest Preview</h1>
        <p>{{ frequency|title }} digest for {{ digest_data.period_name }}</p>
        <div class="preview-meta">
            <span>{{ digest_data.total_posts }} posts</span>
            <span>{{ digest_data.start_date.strftime('%B %d') }} - {{ digest_data.end_date.strftime('%B %d, %Y') }}</span>
        </div>
    </div>
    
    <div class="preview-actions">
        <a href="{{ url_for('newsletter_management') }}" class="btn btn-outline">
            ← Back to Management
        </a>
        <form method="POST" action="{{ url_for('newsletter_management') }}" style="display: inline;">
            {{ csrf_token() }}
            <input type="hidden" name="frequency" value="{{ frequency }}">
            <button type="submit" name="action" value="send_digest" class="btn btn-primary"
                    onclick="return confirm('Send this digest to all {{ frequency }} subscribers?')">
                Send to Subscribers
            </button>
        </form>
    </div>
    
    <!-- Email Preview -->
    <div class="email-preview">
        <div class="email-header">
            <h2>Email Preview</h2>
            <p>This is how the digest will appear in subscribers' inboxes.</p>
        </div>
        
        <div class="email-content">
            <!-- Mimic email styling -->
            <div class="email-wrapper">
                <header class="email-header-content">
                    <h1>Smileys Blog</h1>
                    <p>{{ digest_data.period_name }} Digest</p>
                </header>
                
                <div class="email-body">
                    <p>Here are the latest posts from {{ digest_data.period_name.lower() }}:</p>
                    
                    {% for post in digest_data.posts %}
                        <article class="digest-post">
                            <h3>
                                <a href="{{ post.url }}">{{ post.title }}</a>
                            </h3>
                            
                            <div class="post-meta">
                                {% if post.category %}
                                    <span class="post-category">{{ post.category|title }}</span>
                                {% endif %}
                                <span class="post-date">{{ post.published_at.strftime('%B %d, %Y') if post.published_at else 'No date' }}</span>
                            </div>
                            
                            <p class="post-excerpt">{{ post.excerpt }}</p>
                            
                            {% if post.tags %}
                                <div class="post-tags">
                                    {% for tag in post.tags %}
                                        <span class="tag">{{ tag.strip() }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <a href="{{ post.url }}" class="read-more">Read More →</a>
                        </article>
                    {% endfor %}
                </div>
                
                <footer class="email-footer">
                    <p>You're receiving this because you subscribed to our newsletter.</p>
                    <p><a href="#">Unsubscribe</a></p>
                </footer>
            </div>
        </div>
    </div>
    
    <!-- Digest Statistics -->
    <div class="digest-stats">
        <h2>Digest Statistics</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-label">Total Posts</span>
                <span class="stat-value">{{ digest_data.total_posts }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Date Range</span>
                <span class="stat-value">{{ (digest_data.end_date - digest_data.start_date).days }} days</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Categories</span>
                <span class="stat-value">
                    {% set categories = digest_data.posts | map(attribute='category') | select | unique | list %}
                    {{ categories | length }}
                </span>
            </div>
        </div>
        
        {% if digest_data.posts %}
            <div class="category-breakdown">
                <h3>Posts by Category</h3>
                {% set category_counts = {} %}
                {% for post in digest_data.posts %}
                    {% if post.category %}
                        {% set _ = category_counts.update({post.category: category_counts.get(post.category, 0) + 1}) %}
                    {% endif %}
                {% endfor %}
                
                {% for category, count in category_counts.items() %}
                    <div class="category-stat">
                        <span class="category-name">{{ category|title }}</span>
                        <span class="category-count">{{ count }}</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}