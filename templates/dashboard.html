{% extends 'base.html' %}

{% block title %}Dashboard - Smileys Blog{% endblock %}

{% block content %}
<section class="container">
  <div class="card">
    <!-- Dashboard Navigation -->
    <nav class="dashboard-nav" style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h1 style="margin: 0; color: #9b5e2b;">Dashboard</h1>
        <div class="dashboard-stats" style="display: flex; gap: 1rem; font-size: 0.9rem; color: #666;">
          <span id="posts-count">Posts: {{ posts.published|length + posts.draft|length + posts.scheduled|length }}</span>
          <span id="comments-count">Comments: <span class="loading">...</span></span>
          <span id="subscribers-count">Subscribers: <span class="loading">...</span></span>
        </div>
      </div>
      
      <div class="nav-sections" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <!-- Content Management -->
        <div class="nav-section">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333;">Content</h3>
          <div style="display: flex; flex-direction: column; gap: 0.3rem;">
            <a class="btn btn-sm" href="#create-post" onclick="scrollToCreatePost()">‚úèÔ∏è Create Post</a>
            <a class="btn btn-sm" href="{{ url_for('media_library') }}">üì∑ Media Library</a>
            <a class="btn btn-sm" href="{{ url_for('explore') }}">üîç Browse Posts</a>
          </div>
        </div>
        
        <!-- Author & Profile -->
        <div class="nav-section">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333;">Profile</h3>
          <div style="display: flex; flex-direction: column; gap: 0.3rem;">
            <a class="btn btn-sm" href="{{ url_for('author_profile_management') }}">üë§ Author Profile</a>
            <a class="btn btn-sm" href="{{ url_for('about') }}" target="_blank">üëÅÔ∏è View About Page</a>
          </div>
        </div>
        
        <!-- Community -->
        <div class="nav-section">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333;">Community</h3>
          <div style="display: flex; flex-direction: column; gap: 0.3rem;">
            <a class="btn btn-sm" href="{{ url_for('comment_moderation') }}">üí¨ Comments <span id="pending-comments-badge" class="badge">...</span></a>
            <a class="btn btn-sm" href="{{ url_for('newsletter_management') }}">üìß Newsletter</a>
          </div>
        </div>
        
        <!-- Analytics & Tools -->
        <div class="nav-section">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333;">Analytics</h3>
          <div style="display: flex; flex-direction: column; gap: 0.3rem;">
            <a class="btn btn-sm" href="#analytics" onclick="showAnalytics()">üìä Analytics</a>
            <a class="btn btn-sm" href="#system-health" onclick="showSystemHealth()">üîß System Health</a>
            <a class="btn btn-sm" href="{{ url_for('search') }}">üîç Search</a>
          </div>
        </div>
        
        <!-- SEO & Feeds -->
        <div class="nav-section">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333;">SEO & Feeds</h3>
          <div style="display: flex; flex-direction: column; gap: 0.3rem;">
            <a class="btn btn-sm" href="{{ url_for('sitemap_html') }}">üó∫Ô∏è Sitemap</a>
            <a class="btn btn-sm" href="{{ url_for('rss_feed') }}" target="_blank">üì° RSS Feed</a>
            <a class="btn btn-sm" href="{{ url_for('atom_feed') }}" target="_blank">üì° Atom Feed</a>
          </div>
        </div>
        
        <!-- Settings & Security -->
        <div class="nav-section">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #333;">Settings</h3>
          <div style="display: flex; flex-direction: column; gap: 0.3rem;">
            <a class="btn btn-sm btn-primary" href="{{ url_for('settings') }}">‚öôÔ∏è Settings</a>
            <a class="btn btn-sm" href="{{ url_for('security_audit_logs') }}">üîí Security Logs</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Analytics Dashboard (Hidden by default) -->
    <div id="analytics-dashboard" class="dashboard-section" style="display: none; margin-bottom: 2rem;">
      <div class="card">
        <h3>Analytics Overview</h3>
        <div id="analytics-content">
          <div class="loading-spinner">Loading analytics...</div>
        </div>
      </div>
    </div>

    <!-- System Health Dashboard (Hidden by default) -->
    <div id="system-health-dashboard" class="dashboard-section" style="display: none; margin-bottom: 2rem;">
      <div class="card">
        <h3>System Health</h3>
        <div id="system-health-content">
          <div class="loading-spinner">Loading system health...</div>
        </div>
      </div>
    </div>

    <!-- Create Post Section -->
    <div id="create-post-section" class="card">
      <h2>Create Post</h2>
    <form method="post" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="form-row">
        <div>
          <label>{{ form.title.label }}</label>
          {{ form.title(class='form-control') }}
        </div>
        <div>
          <label>{{ form.category.label }}</label>
          {{ form.category(class='form-control') }}
        </div>
      </div>
      <div style="margin-top:0.6rem">
        <label>{{ form.tags.label }} (comma separated)</label>
        {{ form.tags(class='form-control') }}
      </div>
      
      <div style="margin-top:0.6rem">
        <label>{{ form.images.label }}</label>
        {{ form.images(class='form-control', multiple=true, accept='image/*') }}
        <small class="form-help">Upload images for your post (JPEG, PNG, GIF supported)</small>
      </div>
      
      <div style="margin-top:0.6rem">
        <label>{{ form.summary.label }}</label>
        {{ form.summary(class='form-control', rows=3, placeholder='Optional summary or excerpt. If left blank, one will be generated automatically.') }}
        <small class="form-help">{{ form.summary.description }}</small>
      </div>
      
      <div class="form-row" style="margin-top:0.6rem">
        <div>
          <label>{{ form.status.label }}</label>
          {{ form.status(class='form-control', id='status-select') }}
        </div>
        <div id="scheduled-time-field" style="display: none;">
          <label>{{ form.scheduled_time.label }}</label>
          {{ form.scheduled_time(class='form-control') }}
          <small class="form-help">{{ form.scheduled_time.description }}</small>
        </div>
      </div>

      <div class="editor-split">
        <div class="editor-pane" style="width: 100%;">
          <label>{{ form.content.label }}</label>
          {{ form.content(id='editor', class='form-control', rows=12, style='display: none;') }}
          
          <!-- Editor Feature Toolbar -->
          <div class="editor-feature-toolbar" style="display: flex !important; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--paper-aged); border-radius: 8px; flex-wrap: wrap; align-items: center; position: relative; z-index: 10; border: 2px solid var(--ink-accent); box-shadow: 0 2px 8px rgba(139, 69, 19, 0.15);">
            <button type="button" class="btn btn-sm" onclick="openExportDialog()" title="Export content to different formats">
              üì§ Export
            </button>
            <button type="button" class="btn btn-sm" onclick="openTemplateDialog()" title="Apply or manage templates">
              üìã Templates
            </button>
            <button type="button" class="btn btn-sm" onclick="validateContent()" title="Validate content before publishing">
              ‚úì Validate
            </button>
            <div style="flex: 1;"></div>
            <button type="button" class="btn btn-sm" onclick="togglePreview()" id="preview-toggle-btn" title="Show/hide preview">
              üëÅÔ∏è Preview
            </button>
          </div>
          
          <!-- Advanced Editor Container -->
          <div id="advanced-editor-container" style="min-height: 400px; margin-bottom: 1rem;">
            <!-- Advanced editor will be initialized here -->
          </div>
          
          <div class="form-actions" style="margin-top:0.6rem">
            <button class="btn btn-primary" type="submit" id="submit-btn">Create Post</button>
          </div>
        </div>

        <aside class="preview-pane" id="preview-pane" aria-live="polite" style="display: none;">
          <div id="preview" class="post-article">
            <header>
              <h2 class="muted">Live preview</h2>
            </header>
            <div class="post-content">Start typing to see a live preview‚Ä¶</div>
          </div>
        </aside>
      </div>
    </form>
  </div>

  <section class="dashboard-posts" style="margin-top:1rem">
    <h3>Existing Posts</h3>
    {% if posts %}
      <form id="bulk-action-form" method="post" action="{{ url_for('bulk_action') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="bulk-actions" style="margin-bottom:1rem; padding:0.8rem; background:#f8f9fa; border-radius:4px;">
          <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
            <label style="font-weight:bold;">
              <input type="checkbox" id="select-all" style="margin-right:0.5rem;">
              Select All
            </label>
            <select name="action" id="bulk-action-select" style="padding:0.3rem;">
              <option value="">Choose Action...</option>
              <option value="draft">Set as Draft</option>
              <option value="published">Publish</option>
              <option value="scheduled">Set as Scheduled</option>
              <option value="delete" style="color:#dc3545;">Delete</option>
            </select>
            <button type="submit" class="btn" id="bulk-action-btn" disabled onclick="return confirmBulkAction()">Apply</button>
          </div>
        </div>
      {% for status, post_list in posts.items() %}
        {% if post_list %}
          <div class="post-status-section">
            <h4>{{ status|title }} Posts ({{ post_list|length }})</h4>
            <div class="post-list">
            {% for p in post_list %}
              <div class="post-card">
                <div style="display:flex; align-items:flex-start; gap:0.8rem;">
                  <label style="margin-top:0.2rem;">
                    <input type="checkbox" name="post_ids" value="{{ p.id }}" class="post-checkbox">
                  </label>
                  <div style="flex:1;">
                    <div class="title"><a href="{{ url_for('post_view', post_id=p.id) }}">{{ p.title }}</a></div>
                    <div class="meta">
                      {{ p.category|title if p.category }} ¬∑ 
                      {% if p.status == 'scheduled' and p.scheduled_publish_at %}
                        Scheduled for {{ p.scheduled_publish_at.strftime('%Y-%m-%d %H:%M') }}
                      {% elif p.published_at %}
                        Published {{ p.published_at.strftime('%Y-%m-%d') }}
                      {% else %}
                        Created {{ p.created_at.strftime('%Y-%m-%d') }}
                      {% endif %}
                      {% if p.tag_count > 0 %} ¬∑ {{ p.tag_count }} tag{{ 's' if p.tag_count != 1 else '' }}{% endif %}
                    </div>
                    {% if p.summary %}
                      <div class="excerpt muted">{{ p.summary }}</div>
                    {% endif %}
                    <div class="post-actions" style="margin-top:8px">
                      <a class="btn" href="{{ url_for('edit_post', post_id=p.id) }}">Edit</a>
                      <button class="btn danger" type="button" onclick="deletePost({{ p.id }})">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
      </form>
    {% else %}
      <div class="card"><p class="muted">No posts yet.</p></div>
    {% endif %}
  </section>

  <script>
  // Cache buster v4.0 - Improved image gallery UI - 2026-01-19
  (function(){
    var editor = document.getElementById('editor');
    var preview = document.getElementById('preview').querySelector('.post-content');
    var statusSelect = document.getElementById('status-select');
    var scheduledTimeField = document.getElementById('scheduled-time-field');
    var submitBtn = document.getElementById('submit-btn');
    
    // Make advancedEditor global so feature toolbar functions can access it
    window.advancedEditor = null;
    var advancedEditor = null;
    
    // Load dashboard statistics
    function loadDashboardStats() {
      // Load comment stats
      fetch('/api/comment/stats')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('comments-count').textContent = `Comments: ${data.stats.total_comments}`;
            const pendingBadge = document.getElementById('pending-comments-badge');
            if (data.stats.pending_comments > 0) {
              pendingBadge.textContent = data.stats.pending_comments;
              pendingBadge.style.display = 'inline';
              pendingBadge.className = 'badge badge-warning';
            } else {
              pendingBadge.style.display = 'none';
            }
          }
        })
        .catch(error => {
          console.error('Error loading comment stats:', error);
          document.getElementById('comments-count').textContent = 'Comments: Error';
        });
      
      // Load newsletter stats
      fetch('/api/newsletter/stats')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('subscribers-count').textContent = `Subscribers: ${data.stats.confirmed_subscriptions}`;
          }
        })
        .catch(error => {
          console.error('Error loading newsletter stats:', error);
          document.getElementById('subscribers-count').textContent = 'Subscribers: Error';
        });
    }
    
    // Initialize Advanced Editor
    async function initAdvancedEditor() {
      try {
        // Check if SimpleEditor is available
        if (typeof window.AdvancedEditor === 'undefined') {
          console.warn('AdvancedEditor (SimpleEditor) not available, falling back to basic editor');
          initBasicEditor();
          return;
        }
        
        const container = document.getElementById('advanced-editor-container');
        if (!container) {
          console.error('Advanced editor container not found');
          initBasicEditor();
          return;
        }
        
        console.log('Initializing Simple Advanced Editor...');
        
        // Create advanced editor instance using SimpleEditor
        advancedEditor = window.advancedEditor = new window.AdvancedEditor({
          container: container,
          content: editor.value || '',
          showToolbar: true,
          showSidebar: true,
          autosave: true,
          autosaveInterval: 30000,
          placeholder: 'Start writing your post...'
        });
        
        // Initialize the editor
        await advancedEditor.initialize();
        
        // Set up event listeners
        advancedEditor.on('update', ({ content }) => {
          // Update hidden textarea
          editor.value = content.html;
          
          // Update preview
          preview.innerHTML = content.html;
          
          // Trigger form validation if needed
          editor.dispatchEvent(new Event('input', { bubbles: true }));
        });
        
        advancedEditor.on('save', ({ content }) => {
          editor.value = content.html;
          console.log('Content saved via advanced editor');
        });
        
        advancedEditor.on('autosave', ({ content }) => {
          editor.value = content.html;
          console.log('Content auto-saved');
        });
        
        // Set initial content if exists
        if (editor.value) {
          advancedEditor.setContent(editor.value);
        }
        
        console.log('Simple Advanced Editor initialized successfully');
        
      } catch (error) {
        console.error('Failed to initialize Advanced Editor:', error);
        initBasicEditor();
      }
    }
    
    // Fallback to basic editor
    function initBasicEditor() {
      console.log('Initializing basic editor fallback');
      
      // Show the original textarea
      editor.style.display = 'block';
      
      // Hide advanced editor container
      const container = document.getElementById('advanced-editor-container');
      if (container) {
        container.style.display = 'none';
      }
      
      // Set up basic preview functionality
      function updatePreview() {
        const content = editor.value || '';
        preview.innerHTML = content || 'Start typing to see a live preview‚Ä¶';
      }
      
      editor.addEventListener('input', updatePreview);
      editor.addEventListener('paste', () => {
        setTimeout(updatePreview, 10);
      });
      
      // Initial preview update
      updatePreview();
    }
    
    // Show analytics dashboard
    window.showAnalytics = function() {
      const analyticsDiv = document.getElementById('analytics-dashboard');
      const systemHealthDiv = document.getElementById('system-health-dashboard');
      
      // Hide system health if visible
      systemHealthDiv.style.display = 'none';
      
      // Toggle analytics
      if (analyticsDiv.style.display === 'none') {
        analyticsDiv.style.display = 'block';
        loadAnalytics();
      } else {
        analyticsDiv.style.display = 'none';
      }
    };
    
    // Show system health dashboard
    window.showSystemHealth = function() {
      const analyticsDiv = document.getElementById('analytics-dashboard');
      const systemHealthDiv = document.getElementById('system-health-dashboard');
      
      // Hide analytics if visible
      analyticsDiv.style.display = 'none';
      
      // Toggle system health
      if (systemHealthDiv.style.display === 'none') {
        systemHealthDiv.style.display = 'block';
        loadSystemHealth();
      } else {
        systemHealthDiv.style.display = 'none';
      }
    };
    
    // Scroll to create post section
    window.scrollToCreatePost = function() {
      document.getElementById('create-post-section').scrollIntoView({ behavior: 'smooth' });
    };
    
    // Load analytics data
    function loadAnalytics() {
      const content = document.getElementById('analytics-content');
      content.innerHTML = '<div class="loading-spinner">Loading analytics...</div>';
      
      fetch('/api/analytics/comprehensive?days=30')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.analytics) {
            const analytics = data.analytics;
            displayComprehensiveAnalytics(analytics);
          } else {
            content.innerHTML = '<div class="error">Error loading analytics data</div>';
          }
        })
        .catch(error => {
          console.error('Error loading analytics:', error);
          content.innerHTML = '<div class="error">Error loading analytics data</div>';
        });
    }
    
    function displayComprehensiveAnalytics(analytics) {
      const content = document.getElementById('analytics-content');
      
      let analyticsHTML = `
        <div class="analytics-header" style="margin-bottom: 2rem; padding: 1rem; background: var(--card); border-radius: 6px; border: 1px solid var(--paper-border);">
          <h4 style="margin: 0 0 0.5rem 0; color: var(--accent);">Analytics Overview (${analytics.period.days} days)</h4>
          <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">
            Period: ${new Date(analytics.period.start_date).toLocaleDateString()} - ${new Date(analytics.period.end_date).toLocaleDateString()}
          </p>
        </div>
        
        <div class="analytics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
      `;
      
      // Content Analytics
      if (analytics.content) {
        const content = analytics.content;
        analyticsHTML += `
          <div class="analytics-card" style="background: var(--card); padding: 1rem; border-radius: 6px; border: 1px solid var(--paper-border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--accent);">Content Performance</h4>
            <div class="stat-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${content.posts_published}</strong>
                <small style="color: var(--muted);">Published</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${content.total_published}</strong>
                <small style="color: var(--muted);">Total Posts</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${content.publishing_rate}</strong>
                <small style="color: var(--muted);">Posts/Day</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${Math.round(content.avg_content_length)}</strong>
                <small style="color: var(--muted);">Avg Length</small>
              </div>
            </div>
            ${content.category_breakdown && content.category_breakdown.length > 0 ? `
              <div style="margin-top: 1rem;">
                <strong style="color: var(--accent);">Categories:</strong>
                <div style="margin-top: 0.5rem;">
                  ${content.category_breakdown.map(cat => 
                    `<span style="display: inline-block; margin: 0.2rem; padding: 0.2rem 0.5rem; background: var(--bg); border-radius: 12px; font-size: 0.8rem;">
                      ${cat.category}: ${cat.count}
                    </span>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Engagement Analytics
      if (analytics.engagement) {
        const engagement = analytics.engagement;
        analyticsHTML += `
          <div class="analytics-card" style="background: var(--card); padding: 1rem; border-radius: 6px; border: 1px solid var(--paper-border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--accent);">User Engagement</h4>
            <div class="stat-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${engagement.comments_approved}</strong>
                <small style="color: var(--muted);">Comments</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${engagement.unique_commenters}</strong>
                <small style="color: var(--muted);">Commenters</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${engagement.approval_rate}%</strong>
                <small style="color: var(--muted);">Approval Rate</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${engagement.avg_comments_per_post}</strong>
                <small style="color: var(--muted);">Avg/Post</small>
              </div>
            </div>
            ${engagement.top_commenters && engagement.top_commenters.length > 0 ? `
              <div style="margin-top: 1rem;">
                <strong style="color: var(--accent);">Top Commenters:</strong>
                <div style="margin-top: 0.5rem; max-height: 120px; overflow-y: auto;">
                  ${engagement.top_commenters.slice(0, 5).map(commenter => 
                    `<div style="display: flex; justify-content: space-between; padding: 0.2rem 0; border-bottom: 1px solid var(--paper-border);">
                      <span style="font-size: 0.85rem;">${commenter.name}</span>
                      <span class="badge" style="font-size: 0.7rem;">${commenter.comment_count}</span>
                    </div>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Newsletter Analytics
      if (analytics.newsletter) {
        const newsletter = analytics.newsletter;
        analyticsHTML += `
          <div class="analytics-card" style="background: var(--card); padding: 1rem; border-radius: 6px; border: 1px solid var(--paper-border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--accent);">Newsletter Growth</h4>
            <div class="stat-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${newsletter.total_active}</strong>
                <small style="color: var(--muted);">Active Subs</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${newsletter.new_subscriptions}</strong>
                <small style="color: var(--muted);">New Subs</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${newsletter.confirmation_rate}%</strong>
                <small style="color: var(--muted);">Confirm Rate</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${newsletter.growth_rate}%</strong>
                <small style="color: var(--muted);">Growth Rate</small>
              </div>
            </div>
            ${newsletter.frequency_breakdown && newsletter.frequency_breakdown.length > 0 ? `
              <div style="margin-top: 1rem;">
                <strong style="color: var(--accent);">Frequency Breakdown:</strong>
                <div style="margin-top: 0.5rem;">
                  ${newsletter.frequency_breakdown.map(freq => 
                    `<span style="display: inline-block; margin: 0.2rem; padding: 0.2rem 0.5rem; background: var(--bg); border-radius: 12px; font-size: 0.8rem;">
                      ${freq.frequency}: ${freq.count}
                    </span>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Search Analytics
      if (analytics.search) {
        const search = analytics.search;
        analyticsHTML += `
          <div class="analytics-card" style="background: var(--card); padding: 1rem; border-radius: 6px; border: 1px solid var(--paper-border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--accent);">Search Activity</h4>
            <div class="stat-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${search.total_searches}</strong>
                <small style="color: var(--muted);">Total Searches</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${search.unique_queries}</strong>
                <small style="color: var(--muted);">Unique Queries</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${search.success_rate}%</strong>
                <small style="color: var(--muted);">Success Rate</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${search.searches_per_day}</strong>
                <small style="color: var(--muted);">Per Day</small>
              </div>
            </div>
            ${search.popular_searches && search.popular_searches.length > 0 ? `
              <div style="margin-top: 1rem;">
                <strong style="color: var(--accent);">Popular Searches:</strong>
                <div style="margin-top: 0.5rem; max-height: 120px; overflow-y: auto;">
                  ${search.popular_searches.slice(0, 5).map(query => 
                    `<div style="display: flex; justify-content: space-between; padding: 0.2rem 0; border-bottom: 1px solid var(--paper-border);">
                      <span style="font-size: 0.85rem;">${query.query}</span>
                      <span class="badge" style="font-size: 0.7rem;">${query.search_count}</span>
                    </div>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Growth Metrics
      if (analytics.growth) {
        const growth = analytics.growth;
        analyticsHTML += `
          <div class="analytics-card" style="background: var(--card); padding: 1rem; border-radius: 6px; border: 1px solid var(--paper-border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--accent);">Growth Trends</h4>
            <div style="font-size: 0.85rem;">
        `;
        
        Object.keys(growth).forEach(period => {
          if (growth[period] && typeof growth[period] === 'object') {
            const data = growth[period];
            analyticsHTML += `
              <div style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="color: var(--accent);">${period.replace('_', ' ').toUpperCase()}:</strong>
                <div style="margin-top: 0.3rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                  <div>Posts: ${data.posts} (${data.posts_per_day}/day)</div>
                  <div>Comments: ${data.comments} (${data.comments_per_day}/day)</div>
                  <div>Subscribers: ${data.newsletter_subscribers} (${data.subscribers_per_day}/day)</div>
                  <div>Searches: ${data.searches} (${data.searches_per_day}/day)</div>
                </div>
              </div>
            `;
          }
        });
        
        analyticsHTML += `
            </div>
          </div>
        `;
      }
      
      // Performance Metrics
      if (analytics.performance) {
        const performance = analytics.performance;
        analyticsHTML += `
          <div class="analytics-card" style="background: var(--card); padding: 1rem; border-radius: 6px; border: 1px solid var(--paper-border);">
            <h4 style="margin: 0 0 1rem 0; color: var(--accent);">System Performance</h4>
            <div class="stat-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${performance.publishing_efficiency}%</strong>
                <small style="color: var(--muted);">Publish Efficiency</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${performance.search_success_rate}%</strong>
                <small style="color: var(--muted);">Search Success</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${performance.content_creation_velocity}</strong>
                <small style="color: var(--muted);">Content Velocity</small>
              </div>
              <div style="text-align: center; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                <strong style="display: block; font-size: 1.2rem; color: var(--accent);">${performance.comment_moderation_efficiency}%</strong>
                <small style="color: var(--muted);">Moderation Eff.</small>
              </div>
            </div>
          </div>
        `;
      }
      
      analyticsHTML += '</div>';
      
      // Add export button
      analyticsHTML += `
        <div style="margin-top: 2rem; text-align: center;">
          <a href="/api/analytics/export?days=30&format=json" class="btn btn-sm" download="analytics_report.json">
            üìä Export Analytics Report
          </a>
        </div>
      `;
      
      content.innerHTML = analyticsHTML;
    }
    
    // Load system health data
    function loadSystemHealth() {
      const content = document.getElementById('system-health-content');
      content.innerHTML = '<div class="loading-spinner">Loading system health...</div>';
      
      fetch('/api/system/health')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const health = data.health;
            const components = health.components;
            
            let healthHTML = `
              <div class="health-overview" style="margin-bottom: 2rem; padding: 1rem; background: ${getStatusColor(health.overall_status)}; border-radius: 6px; border: 2px solid rgba(100, 100, 100, 0.3);">
                <h4 style="margin: 0 0 0.5rem 0;">Overall Status: ${health.overall_status.toUpperCase()}</h4>
                <p style="margin: 0; font-size: 0.9rem;">
                  Last checked: ${new Date(health.check_timestamp).toLocaleString()}<br>
                  Check duration: ${health.check_duration}s
                </p>
              </div>
              
              <div class="health-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
            `;
            
            // Database Health
            if (components.database) {
              const db = components.database;
              healthHTML += `
                <div class="health-card" style="background: ${getStatusColor(db.status || 'unknown')}; padding: 1rem; border-radius: 6px; border: 2px solid rgba(100, 100, 100, 0.3);">
                  <h4 style="margin: 0 0 1rem 0;">Database</h4>
                  <div class="status-indicator">${getStatusIcon(db.status || 'unknown')} ${db.message || 'Status unknown'}</div>
                  ${db.details ? `
                  <div style="margin-top: 1rem; font-size: 0.85rem;">
                    ${db.details.query_time !== undefined ? `<div>Query Time: ${db.details.query_time}s</div>` : ''}
                    ${db.details.post_count !== undefined ? `<div>Posts: ${db.details.post_count}</div>` : ''}
                    ${db.details.comment_count !== undefined ? `<div>Comments: ${db.details.comment_count}</div>` : ''}
                    ${db.details.subscription_count !== undefined ? `<div>Subscriptions: ${db.details.subscription_count}</div>` : ''}
                  </div>
                  ` : ''}
                </div>
              `;
            }
            
            // Search Index Health
            if (components.search_index) {
              const search = components.search_index;
              healthHTML += `
                <div class="health-card" style="background: ${getStatusColor(search.status || 'unknown')}; padding: 1rem; border-radius: 6px; border: 2px solid rgba(100, 100, 100, 0.3);">
                  <h4 style="margin: 0 0 1rem 0;">Search Index</h4>
                  <div class="status-indicator">${getStatusIcon(search.status || 'unknown')} ${search.message || 'Status unknown'}</div>
                  ${search.details ? `
                  <div style="margin-top: 1rem; font-size: 0.85rem;">
                    ${search.details.coverage_percentage !== undefined ? `<div>Coverage: ${search.details.coverage_percentage}%</div>` : ''}
                    ${search.details.indexed_count !== undefined && search.details.published_count !== undefined ? `<div>Indexed: ${search.details.indexed_count}/${search.details.published_count}</div>` : ''}
                    ${search.details.test_query_time ? `<div>Query Time: ${search.details.test_query_time}s</div>` : ''}
                  </div>
                  ` : ''}
                </div>
              `;
            }
                  </div>
                </div>
              `;
            }
            
            // Email Service Health
            if (components.email_service) {
              const email = components.email_service;
              healthHTML += `
                <div class="health-card" style="background: ${getStatusColor(email.status || 'unknown')}; padding: 1rem; border-radius: 6px; border: 2px solid rgba(100, 100, 100, 0.3);">
                  <h4 style="margin: 0 0 1rem 0;">Email Service</h4>
                  <div class="status-indicator">${getStatusIcon(email.status || 'unknown')} ${email.message || 'Status unknown'}</div>
                  ${email.details ? `
                  <div style="margin-top: 1rem; font-size: 0.85rem;">
                    ${email.details.configured !== undefined ? `<div>Configured: ${email.details.configured ? 'Yes' : 'No'}</div>` : ''}
                    ${email.details.api_test_time ? `<div>API Response: ${email.details.api_test_time}s</div>` : ''}
                    ${email.details.active_subscriptions !== undefined ? `<div>Active Subscribers: ${email.details.active_subscriptions}</div>` : ''}
                  </div>
                  ` : ''}
                </div>
              `;
            }
            
            // Feed Generation Health
            if (components.feed_generation) {
              const feeds = components.feed_generation;
              healthHTML += `
                <div class="health-card" style="background: ${getStatusColor(feeds.status || 'unknown')}; padding: 1rem; border-radius: 6px; border: 2px solid rgba(100, 100, 100, 0.3);">
                  <h4 style="margin: 0 0 1rem 0;">Feed Generation</h4>
                  <div class="status-indicator">${getStatusIcon(feeds.status || 'unknown')} ${feeds.message || 'Status unknown'}</div>
                  ${feeds.details ? `
                  <div style="margin-top: 1rem; font-size: 0.85rem;">
                    ${feeds.details.rss_success !== undefined ? `<div>RSS: ${feeds.details.rss_success ? '‚úÖ' : '‚ùå'}${feeds.details.rss_generation_time ? ` (${feeds.details.rss_generation_time}s)` : ''}</div>` : ''}
                    ${feeds.details.atom_success !== undefined ? `<div>Atom: ${feeds.details.atom_success ? '‚úÖ' : '‚ùå'}${feeds.details.atom_generation_time ? ` (${feeds.details.atom_generation_time}s)` : ''}</div>` : ''}
                    ${feeds.details.total_time !== undefined ? `<div>Total Time: ${feeds.details.total_time}s</div>` : ''}
                  </div>
                  ` : ''}
                </div>
              `;
            }
            
            // File System Health
            if (components.file_system) {
              const fs = components.file_system;
              healthHTML += `
                <div class="health-card" style="background: ${getStatusColor(fs.status || 'unknown')}; padding: 1rem; border-radius: 6px; border: 2px solid rgba(100, 100, 100, 0.3);">
                  <h4 style="margin: 0 0 1rem 0;">File System</h4>
                  <div class="status-indicator">${getStatusIcon(fs.status || 'unknown')} ${fs.message || 'Status unknown'}</div>
                  ${fs.details ? `
                  <div style="margin-top: 1rem; font-size: 0.85rem;">
                    ${fs.details.disk_usage_percent !== undefined ? `<div>Disk Usage: ${fs.details.disk_usage_percent}%</div>` : ''}
                    ${fs.details.disk_free_gb !== undefined ? `<div>Free Space: ${fs.details.disk_free_gb}GB</div>` : ''}
                    ${fs.details.database_size_mb !== undefined ? `<div>Database: ${fs.details.database_size_mb}MB</div>` : ''}
                    ${fs.details.uploaded_files_count !== undefined ? `<div>Upload Files: ${fs.details.uploaded_files_count}</div>` : ''}
                  </div>
                  ` : ''}
                </div>
              `;
            }
            
            // Performance Metrics
            if (components.performance) {
              const perf = components.performance;
              healthHTML += `
                <div class="health-card" style="background: ${getStatusColor(perf.status || 'unknown')}; padding: 1rem; border-radius: 6px; border: 2px solid rgba(100, 100, 100, 0.3);">
                  <h4 style="margin: 0 0 1rem 0;">Performance</h4>
                  <div class="status-indicator">${getStatusIcon(perf.status || 'unknown')} ${perf.message || 'Status unknown'}</div>
                  ${perf.details ? `
                  <div style="margin-top: 1rem; font-size: 0.85rem;">
                    ${perf.details.cpu_percent !== undefined ? `<div>CPU: ${perf.details.cpu_percent}%</div>` : ''}
                    ${perf.details.memory_percent !== undefined ? `<div>Memory: ${perf.details.memory_percent}%</div>` : ''}
                    ${perf.details.process_memory_mb !== undefined ? `<div>App Memory: ${perf.details.process_memory_mb}MB</div>` : ''}
                    ${perf.details.recent_searches !== undefined ? `<div>Recent Searches: ${perf.details.recent_searches}</div>` : ''}
                  </div>
                  ` : ''}
                </div>
              `;
            }
            
            healthHTML += '</div>';
            content.innerHTML = healthHTML;
          } else {
            content.innerHTML = '<div class="error">Error loading system health data</div>';
          }
        })
        .catch(error => {
          console.error('Error loading system health:', error);
          content.innerHTML = '<div class="error">Error loading system health data</div>';
        });
    }
    
    // Helper functions for health status display
    function getStatusColor(status) {
      // Normalize status - handle both 'operational' and 'healthy'
      if (!status) status = 'unknown';
      const normalizedStatus = status.toLowerCase();
      const mappedStatus = normalizedStatus === 'operational' ? 'healthy' : normalizedStatus;
      
      // Check if dark mode is active
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      
      if (isDarkMode) {
        // Dark mode colors - much darker backgrounds with colored borders
        const darkColors = {
          'healthy': 'rgba(34, 197, 94, 0.25)',
          'warning': 'rgba(251, 191, 36, 0.25)',
          'critical': 'rgba(239, 68, 68, 0.25)',
          'unknown': 'rgba(100, 100, 100, 0.25)'
        };
        return darkColors[mappedStatus] || darkColors.unknown;
      } else {
        // Light mode colors
        const lightColors = {
          'healthy': '#e6f5e9',
          'warning': '#fff6d6',
          'critical': '#ffe4e0',
          'unknown': '#f3f4f6'
        };
        return lightColors[mappedStatus] || lightColors.unknown;
      }
    }
    
    function getStatusIcon(status) {
      // Normalize status - handle both 'operational' and 'healthy'
      if (!status) status = 'unknown';
      const normalizedStatus = status.toLowerCase();
      const mappedStatus = normalizedStatus === 'operational' ? 'healthy' : normalizedStatus;
      
      const icons = {
        'healthy': '‚úÖ',
        'warning': '‚ö†Ô∏è',
        'critical': '‚ùå',
        'unknown': '‚ùì'
      };
      return icons[mappedStatus] || icons.unknown;
    }
    
    // Handle status selection changes
    function updateStatusUI() {
      var status = statusSelect.value;
      
      // Show/hide scheduled time field
      if (status === 'scheduled') {
        scheduledTimeField.style.display = 'block';
      } else {
        scheduledTimeField.style.display = 'none';
      }
      
      // Update submit button text
      var buttonText = {
        'draft': 'Save as Draft',
        'published': 'Publish Now',
        'scheduled': 'Schedule Post'
      };
      submitBtn.textContent = buttonText[status] || 'Create Post';
    }
    
    // Listen for status changes
    statusSelect.addEventListener('change', updateStatusUI);
    
    // Initialize status UI
    updateStatusUI();
    
    // Load dashboard stats on page load
    loadDashboardStats();
    
    // Refresh stats every 5 minutes
    setInterval(loadDashboardStats, 300000);
    
    // Enhanced toolbar with image functionality
    function createToolbar() {
      var toolbar = document.createElement('div');
      toolbar.className = 'editor-toolbar';
      toolbar.innerHTML = `
        <button type="button" onclick="formatText('bold')" title="Bold"><b>B</b></button>
        <button type="button" onclick="formatText('italic')" title="Italic"><i>I</i></button>
        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
        <button type="button" onclick="insertLink()" title="Insert Link">üîó</button>
        <button type="button" onclick="formatText('formatBlock', 'h2')" title="Heading">H2</button>
        <button type="button" onclick="formatText('formatBlock', 'h3')" title="Subheading">H3</button>
        <button type="button" onclick="showImageUploader()" title="Insert Image">üì∑ Image</button>
        <button type="button" onclick="showImageGallery()" title="Image Gallery">üñºÔ∏è Gallery</button>
      `;
      return toolbar;
    }
    
    // Make editor contenteditable with basic formatting and drag-drop
    function initEditor() {
      // Insert toolbar before editor
      var toolbar = createToolbar();
      editor.parentNode.insertBefore(toolbar, editor);
      
      // Convert textarea to contenteditable div
      var editorDiv = document.createElement('div');
      editorDiv.id = 'editor-content';
      editorDiv.className = 'form-control editor-content';
      editorDiv.contentEditable = true;
      editorDiv.innerHTML = editor.value || '<p>Start writing your post...</p>';
      
      // Replace textarea with contenteditable div
      editor.style.display = 'none';
      editor.parentNode.insertBefore(editorDiv, editor.nextSibling);
      
      // Add drag and drop functionality
      setupDragAndDrop(editorDiv);
      
      // Update preview and hidden textarea on input
      function updateContent() {
        var content = editorDiv.innerHTML;
        // Clean up the HTML a bit
        content = content.replace(/<div><br><\/div>/g, '<p><br></p>');
        content = content.replace(/<div>/g, '<p>').replace(/<\/div>/g, '</p>');
        
        editor.value = content;
        preview.innerHTML = content;
      }
      
      editorDiv.addEventListener('input', updateContent);
      editorDiv.addEventListener('paste', function(e) {
        // Handle image paste
        var items = e.clipboardData.items;
        for (var i = 0; i < items.length; i++) {
          if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            var file = items[i].getAsFile();
            uploadImageToEditor(file);
            return;
          }
        }
        setTimeout(updateContent, 10); // Allow paste to complete
      });
      
      // Initial preview update
      updateContent();
      
      // Focus the editor
      editorDiv.focus();
      
      // Make updateContent globally accessible
      window.updateContent = updateContent;
    }
    
    function setupDragAndDrop(editorDiv) {
      editorDiv.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorDiv.style.backgroundColor = 'rgba(217, 119, 6, 0.1)';
        editorDiv.style.border = '2px dashed var(--accent)';
      });
      
      editorDiv.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorDiv.style.backgroundColor = '';
        editorDiv.style.border = '';
      });
      
      editorDiv.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        editorDiv.style.backgroundColor = '';
        editorDiv.style.border = '';
        
        var files = e.dataTransfer.files;
        for (var i = 0; i < files.length; i++) {
          if (files[i].type.startsWith('image/')) {
            uploadImageToEditor(files[i]);
          }
        }
      });
    }
    
    // Global formatting functions
    window.formatText = function(command, value) {
      document.execCommand(command, false, value);
      document.getElementById('editor-content').focus();
    };
    
    window.insertLink = function() {
      var url = prompt('Enter URL:');
      if (url) {
        document.execCommand('createLink', false, url);
        document.getElementById('editor-content').focus();
      }
    };
    
    // Image upload functionality
    window.showImageUploader = function() {
      // Create file input
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.style.display = 'none';
      
      input.onchange = function(e) {
        var file = e.target.files[0];
        if (file) {
          uploadImageToEditor(file);
        }
      };
      
      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    };
    
    function uploadImageToEditor(file) {
      // Show upload progress
      var editorContent = document.getElementById('editor-content');
      var uploadingDiv = document.createElement('div');
      uploadingDiv.innerHTML = '<p style="color: #666; font-style: italic;">üì§ Uploading image...</p>';
      
      // Insert at cursor position
      var selection = window.getSelection();
      if (selection.rangeCount > 0) {
        var range = selection.getRangeAt(0);
        range.insertNode(uploadingDiv);
        range.collapse(false);
      } else {
        editorContent.appendChild(uploadingDiv);
      }
      
      // Create FormData
      var formData = new FormData();
      formData.append('image', file);
      
      // Get CSRF token
      var csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
      
      fetch('/api/upload-editor-image', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Replace uploading message with actual image
          var img = document.createElement('img');
          img.src = data.url;
          img.alt = data.filename;
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          img.style.borderRadius = '8px';
          img.style.margin = '1rem 0';
          img.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
          img.className = 'editor-image';
          
          uploadingDiv.parentNode.replaceChild(img, uploadingDiv);
          
          // Update the hidden textarea
          window.updateContent();
          
          // Debug: log the content
          console.log('Content after image upload:', document.getElementById('editor').value);
          
          // Show success message
          showNotification('Image uploaded successfully!', 'success');
        } else {
          uploadingDiv.innerHTML = '<p style="color: #dc3545;">‚ùå Upload failed: ' + data.error + '</p>';
          setTimeout(() => {
            if (uploadingDiv.parentNode) {
              uploadingDiv.parentNode.removeChild(uploadingDiv);
            }
          }, 3000);
        }
      })
      .catch(error => {
        console.error('Upload error:', error);
        uploadingDiv.innerHTML = '<p style="color: #dc3545;">‚ùå Upload failed: Network error</p>';
        setTimeout(() => {
          if (uploadingDiv.parentNode) {
            uploadingDiv.parentNode.removeChild(uploadingDiv);
          }
        }, 3000);
      });
    }
    
    // Image gallery functionality
    window.showImageGallery = function() {
      fetch('/api/editor-images')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showImageGalleryModal(data.images);
          } else {
            showNotification('Failed to load images: ' + data.error, 'error');
          }
        })
        .catch(error => {
          console.error('Gallery error:', error);
          showNotification('Failed to load image gallery', 'error');
        });
    };
    
    function showImageGalleryModal(images) {
      // Create modal overlay
      var modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        animation: fadeIn 0.2s ease-in;
      `;
      
      var modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: var(--paper-cream, #fef9f3);
        border-radius: 16px;
        padding: 0;
        max-width: 900px;
        max-height: 85vh;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      `;
      
      // Header with tabs
      var header = document.createElement('div');
      header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        border-bottom: 2px solid var(--paper-shadow, #e8d5c4);
        background: var(--paper-aged, #faf5ef);
      `;
      
      header.innerHTML = `
        <div>
          <h3 style="margin: 0 0 0.5rem 0; color: var(--ink-accent, #9b5e2b); font-family: var(--heading-font, Georgia); font-size: 1.5rem;">üì∑ Media Manager</h3>
          <p style="margin: 0; color: var(--ink-medium, #6b5d54); font-size: 0.9rem;">Upload new images or select from your library</p>
        </div>
        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--ink-medium, #6b5d54); line-height: 1; padding: 0; width: 32px; height: 32px; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='rgba(155,94,43,0.1)'" onmouseout="this.style.background='none'">√ó</button>
      `;
      
      // Tab navigation
      var tabNav = document.createElement('div');
      tabNav.style.cssText = `
        display: flex;
        gap: 0.5rem;
        padding: 1rem 2rem 0 2rem;
        background: var(--paper-aged, #faf5ef);
      `;
      
      tabNav.innerHTML = `
        <button class="tab-btn active" data-tab="upload" style="padding: 0.75rem 1.5rem; border: none; background: var(--paper-cream, #fef9f3); color: var(--ink-accent, #9b5e2b); border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; border-bottom: 3px solid var(--ink-accent, #9b5e2b); transition: all 0.2s;">
          üì§ Upload
        </button>
        <button class="tab-btn" data-tab="library" style="padding: 0.75rem 1.5rem; border: none; background: transparent; color: var(--ink-medium, #6b5d54); border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s;">
          üñºÔ∏è Library (${images.length})
        </button>
      `;
      
      // Content area
      var contentArea = document.createElement('div');
      contentArea.style.cssText = `
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        background: var(--paper-cream, #fef9f3);
      `;
      
      // Upload tab content
      var uploadTab = document.createElement('div');
      uploadTab.className = 'tab-content active';
      uploadTab.setAttribute('data-tab', 'upload');
      uploadTab.style.cssText = `display: block;`;
      
      uploadTab.innerHTML = `
        <div class="upload-area" style="
          border: 3px dashed var(--paper-shadow, #d4c4b0);
          border-radius: 12px;
          padding: 3rem 2rem;
          text-align: center;
          background: var(--paper-aged, #faf5ef);
          transition: all 0.3s;
          cursor: pointer;
        " onmouseover="this.style.borderColor='var(--ink-accent, #9b5e2b)'; this.style.background='rgba(155,94,43,0.05)'" onmouseout="this.style.borderColor='var(--paper-shadow, #d4c4b0)'; this.style.background='var(--paper-aged, #faf5ef)'">
          <div style="font-size: 4rem; margin-bottom: 1rem;">üìÅ</div>
          <h4 style="margin: 0 0 0.5rem 0; color: var(--ink-accent, #9b5e2b); font-size: 1.2rem;">Drop images here or click to browse</h4>
          <p style="margin: 0 0 1rem 0; color: var(--ink-medium, #6b5d54); font-size: 0.9rem;">Supports: JPEG, PNG, GIF, WebP (Max 10MB)</p>
          <button class="btn btn-primary" style="padding: 0.75rem 2rem; font-size: 1rem;">
            Choose Files
          </button>
          <input type="file" id="image-upload-input" accept="image/*" multiple style="display: none;">
        </div>
        
        <div id="upload-preview" style="margin-top: 2rem; display: none;">
          <h4 style="margin: 0 0 1rem 0; color: var(--ink-accent, #9b5e2b);">Selected Files:</h4>
          <div id="preview-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem;"></div>
          <div style="margin-top: 1.5rem; text-align: center;">
            <button id="upload-btn" class="btn btn-primary" style="padding: 0.75rem 2rem; font-size: 1rem;">
              Upload All
            </button>
            <button id="cancel-upload-btn" class="btn" style="padding: 0.75rem 2rem; font-size: 1rem; margin-left: 0.5rem;">
              Cancel
            </button>
          </div>
        </div>
        
        <div id="upload-progress" style="margin-top: 2rem; display: none;">
          <div style="background: var(--paper-aged, #faf5ef); border-radius: 8px; padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <span style="color: var(--ink-accent, #9b5e2b); font-weight: 600;">Uploading...</span>
              <span id="upload-percent" style="color: var(--ink-medium, #6b5d54);">0%</span>
            </div>
            <div style="background: var(--paper-shadow, #d4c4b0); height: 8px; border-radius: 4px; overflow: hidden;">
              <div id="upload-bar" style="background: var(--ink-accent, #9b5e2b); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>
      `;
      
      // Library tab content
      var libraryTab = document.createElement('div');
      libraryTab.className = 'tab-content';
      libraryTab.setAttribute('data-tab', 'library');
      libraryTab.style.cssText = `display: none;`;
      
      if (images.length === 0) {
        libraryTab.innerHTML = `
          <div style="text-align: center; padding: 4rem 2rem; color: var(--ink-medium, #6b5d54);">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üñºÔ∏è</div>
            <h4 style="margin: 0 0 0.5rem 0; color: var(--ink-accent, #9b5e2b);">No images yet</h4>
            <p style="margin: 0;">Upload some images to get started!</p>
          </div>
        `;
      } else {
        var galleryGrid = document.createElement('div');
        galleryGrid.style.cssText = `
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
          gap: 1.5rem;
        `;
        
        images.forEach(image => {
          var imageCard = document.createElement('div');
          imageCard.style.cssText = `
            border: 2px solid var(--paper-shadow, #d4c4b0);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
          `;
          
          imageCard.innerHTML = `
            <div style="position: relative; padding-top: 75%; overflow: hidden; background: var(--paper-aged, #faf5ef);">
              <img src="${image.url}" alt="${image.original_name}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
              <div class="image-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(155,94,43,0.9); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                <span style="color: white; font-weight: 600; font-size: 1.1rem;">‚úì Select</span>
              </div>
            </div>
            <div style="padding: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.25rem; color: var(--ink-accent, #9b5e2b); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${image.original_name}">${image.original_name}</div>
              <div style="font-size: 0.8rem; color: var(--ink-medium, #6b5d54);">${(image.file_size / 1024).toFixed(1)} KB</div>
            </div>
          `;
          
          imageCard.onmouseover = () => {
            imageCard.style.transform = 'translateY(-4px)';
            imageCard.style.boxShadow = '0 8px 24px rgba(155,94,43,0.2)';
            imageCard.style.borderColor = 'var(--ink-accent, #9b5e2b)';
            imageCard.querySelector('.image-overlay').style.opacity = '1';
          };
          
          imageCard.onmouseout = () => {
            imageCard.style.transform = 'translateY(0)';
            imageCard.style.boxShadow = 'none';
            imageCard.style.borderColor = 'var(--paper-shadow, #d4c4b0)';
            imageCard.querySelector('.image-overlay').style.opacity = '0';
          };
          
          imageCard.onclick = () => {
            insertImageIntoEditor(image.url, image.original_name);
            modal.remove();
          };
          
          galleryGrid.appendChild(imageCard);
        });
        
        libraryTab.appendChild(galleryGrid);
      }
      
      contentArea.appendChild(uploadTab);
      contentArea.appendChild(libraryTab);
      
      modalContent.appendChild(header);
      modalContent.appendChild(tabNav);
      modalContent.appendChild(contentArea);
      modal.appendChild(modalContent);
      modal.className = 'modal';
      
      // Tab switching
      tabNav.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
          const tabName = btn.getAttribute('data-tab');
          
          // Update buttons
          tabNav.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
            b.style.background = 'transparent';
            b.style.color = 'var(--ink-medium, #6b5d54)';
            b.style.borderBottom = '3px solid transparent';
          });
          btn.classList.add('active');
          btn.style.background = 'var(--paper-cream, #fef9f3)';
          btn.style.color = 'var(--ink-accent, #9b5e2b)';
          btn.style.borderBottom = '3px solid var(--ink-accent, #9b5e2b)';
          
          // Update content
          contentArea.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
          });
          contentArea.querySelector(`[data-tab="${tabName}"]`).style.display = 'block';
        };
      });
      
      // Upload functionality
      const uploadArea = uploadTab.querySelector('.upload-area');
      const fileInput = uploadTab.querySelector('#image-upload-input');
      const uploadPreview = uploadTab.querySelector('#upload-preview');
      const previewGrid = uploadTab.querySelector('#preview-grid');
      const uploadBtn = uploadTab.querySelector('#upload-btn');
      const cancelBtn = uploadTab.querySelector('#cancel-upload-btn');
      const uploadProgress = uploadTab.querySelector('#upload-progress');
      
      let selectedFiles = [];
      
      uploadArea.onclick = () => fileInput.click();
      
      fileInput.onchange = (e) => {
        selectedFiles = Array.from(e.target.files);
        showPreview();
      };
      
      // Drag and drop
      uploadArea.ondragover = (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--ink-accent, #9b5e2b)';
        uploadArea.style.background = 'rgba(155,94,43,0.1)';
      };
      
      uploadArea.ondragleave = () => {
        uploadArea.style.borderColor = 'var(--paper-shadow, #d4c4b0)';
        uploadArea.style.background = 'var(--paper-aged, #faf5ef)';
      };
      
      uploadArea.ondrop = (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--paper-shadow, #d4c4b0)';
        uploadArea.style.background = 'var(--paper-aged, #faf5ef)';
        selectedFiles = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        showPreview();
      };
      
      function showPreview() {
        if (selectedFiles.length === 0) return;
        
        previewGrid.innerHTML = '';
        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.createElement('div');
            preview.style.cssText = `
              position: relative;
              border: 2px solid var(--paper-shadow, #d4c4b0);
              border-radius: 8px;
              overflow: hidden;
            `;
            preview.innerHTML = `
              <img src="${e.target.result}" style="width: 100%; height: 120px; object-fit: cover;">
              <button onclick="this.closest('div').remove()" style="position: absolute; top: 4px; right: 4px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 0.9rem; line-height: 1;">√ó</button>
              <div style="padding: 0.5rem; background: white; font-size: 0.75rem; color: var(--ink-medium, #6b5d54); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
            `;
            previewGrid.appendChild(preview);
          };
          reader.readAsDataURL(file);
        });
        
        uploadArea.style.display = 'none';
        uploadPreview.style.display = 'block';
      }
      
      cancelBtn.onclick = () => {
        selectedFiles = [];
        fileInput.value = '';
        uploadArea.style.display = 'block';
        uploadPreview.style.display = 'none';
      };
      
      uploadBtn.onclick = async () => {
        uploadPreview.style.display = 'none';
        uploadProgress.style.display = 'block';
        
        const uploadBar = uploadProgress.querySelector('#upload-bar');
        const uploadPercent = uploadProgress.querySelector('#upload-percent');
        
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const formData = new FormData();
          formData.append('image', file);
          
          try {
            const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
            const response = await fetch('/api/upload-image', {
              method: 'POST',
              headers: { 'X-CSRFToken': csrfToken },
              body: formData
            });
            
            const percent = Math.round(((i + 1) / selectedFiles.length) * 100);
            uploadBar.style.width = percent + '%';
            uploadPercent.textContent = percent + '%';
            
          } catch (error) {
            console.error('Upload error:', error);
          }
        }
        
        // Reload gallery
        setTimeout(() => {
          modal.remove();
          showImageGallery();
        }, 500);
      };
      
      // Close on background click
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      };
      
      document.body.appendChild(modal);
    }
    
    function insertImageIntoEditor(url, altText) {
      var img = document.createElement('img');
      img.src = url;
      img.alt = altText;
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.style.borderRadius = '8px';
      img.style.margin = '1rem 0';
      img.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
      img.className = 'editor-image';
      
      var editorContent = document.getElementById('editor-content');
      var selection = window.getSelection();
      
      if (selection.rangeCount > 0) {
        var range = selection.getRangeAt(0);
        range.insertNode(img);
        range.collapse(false);
      } else {
        editorContent.appendChild(img);
      }
      
      // Update the hidden textarea
      window.updateContent();
      
      // Debug: log the content
      console.log('Content after image insertion:', document.getElementById('editor').value);
      
      showNotification('Image inserted successfully!', 'success');
    }
    
    function showNotification(message, type) {
      var notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10001;
        animation: slideInRight 0.3s ease-out;
      `;
      
      if (type === 'success') {
        notification.style.background = '#28a745';
      } else if (type === 'error') {
        notification.style.background = '#dc3545';
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing SimpleEditor...');
        console.log('SimpleEditor available:', typeof window.AdvancedEditor !== 'undefined');
        initAdvancedEditor();
      });
    } else {
      console.log('DOM already ready, initializing SimpleEditor...');
      console.log('SimpleEditor available:', typeof window.AdvancedEditor !== 'undefined');
      initAdvancedEditor();
    }
    
    // Bulk actions functionality
    var selectAllCheckbox = document.getElementById('select-all');
    var postCheckboxes = document.querySelectorAll('.post-checkbox');
    var bulkActionSelect = document.getElementById('bulk-action-select');
    var bulkActionBtn = document.getElementById('bulk-action-btn');
    
    if (selectAllCheckbox && postCheckboxes.length > 0) {
      // Handle select all checkbox
      selectAllCheckbox.addEventListener('change', function() {
        postCheckboxes.forEach(function(checkbox) {
          checkbox.checked = selectAllCheckbox.checked;
        });
        updateBulkActionButton();
      });
      
      // Handle individual checkboxes
      postCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          updateSelectAllState();
          updateBulkActionButton();
        });
      });
      
      // Handle bulk action selection
      if (bulkActionSelect) {
        bulkActionSelect.addEventListener('change', updateBulkActionButton);
      }
    }
    
    function updateSelectAllState() {
      var checkedCount = document.querySelectorAll('.post-checkbox:checked').length;
      var totalCount = postCheckboxes.length;
      
      if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCount === totalCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }
    
    function updateBulkActionButton() {
      var checkedCount = document.querySelectorAll('.post-checkbox:checked').length;
      var actionSelected = bulkActionSelect && bulkActionSelect.value;
      
      if (bulkActionBtn) {
        bulkActionBtn.disabled = checkedCount === 0 || !actionSelected;
      }
    }
    
    window.confirmBulkAction = function() {
      var checkedCount = document.querySelectorAll('.post-checkbox:checked').length;
      var action = bulkActionSelect.value;
      
      if (checkedCount === 0) {
        alert('Please select at least one post.');
        return false;
      }
      
      if (!action) {
        alert('Please select an action.');
        return false;
      }
      
      var actionText = {
        'draft': 'set as draft',
        'published': 'publish',
        'scheduled': 'set as scheduled',
        'delete': 'delete'
      }[action] || action;
      
      var message = `Are you sure you want to ${actionText} ${checkedCount} post(s)?`;
      
      if (action === 'delete') {
        message += '\n\nThis action cannot be undone.';
      }
      
      return confirm(message);
    };
    
    // Delete individual post
    window.deletePost = function(postId) {
      if (!confirm('Delete this post? This action cannot be undone.')) {
        return;
      }
      
      // Create a temporary form to submit the delete request
      var form = document.createElement('form');
      form.method = 'POST';
      form.action = '/dashboard/delete/' + postId;
      
      // Add CSRF token
      var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      var csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrf_token';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
      
      // Add form to body and submit
      document.body.appendChild(form);
      form.submit();
    };
    
  })();
  
  // ============================================
  // FEATURE TOOLBAR FUNCTIONS
  // ============================================
  
  // Toggle preview pane visibility
  window.togglePreview = function() {
    const previewPane = document.getElementById('preview-pane');
    const toggleBtn = document.getElementById('preview-toggle-btn');
    
    if (previewPane.style.display === 'none' || !previewPane.style.display) {
      previewPane.style.display = 'block';
      toggleBtn.textContent = 'üëÅÔ∏è Hide Preview';
    } else {
      previewPane.style.display = 'none';
      toggleBtn.textContent = 'üëÅÔ∏è Show Preview';
    }
  };
  
  // Open export dialog
  window.openExportDialog = function() {
    // Check if advanced editor is available
    if (!window.advancedEditor) {
      alert('Editor is still loading. Please wait a moment and try again.');
      console.log('advancedEditor not ready yet');
      return;
    }
    
    if (!window.advancedEditor.exportSystem) {
      console.warn('Export system not available, using basic export');
    }
    
    // Create export modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    `;
    
    modalContent.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; color: #333;">Export Content</h3>
        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">√ó</button>
      </div>
      
      <p style="color: #666; margin-bottom: 1.5rem;">Choose a format to export your content:</p>
      
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <button class="btn btn-primary" onclick="exportContent('html')" style="width: 100%;">
          üìÑ Export as HTML
        </button>
        <button class="btn btn-primary" onclick="exportContent('markdown')" style="width: 100%;">
          üìù Export as Markdown
        </button>
        <button class="btn btn-primary" onclick="exportContent('json')" style="width: 100%;">
          üìä Export as JSON
        </button>
      </div>
    `;
    
    modal.appendChild(modalContent);
    
    // Close on background click
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    };
    
    document.body.appendChild(modal);
  };
  
  // Export content in specified format
  window.exportContent = function(format) {
    if (!window.advancedEditor) {
      alert('Editor not available');
      return;
    }
    
    try {
      const content = window.advancedEditor.getContent();
      let exportData;
      let filename;
      let mimeType;
      
      switch(format) {
        case 'html':
          exportData = content.html || content;
          filename = 'content.html';
          mimeType = 'text/html';
          break;
        case 'markdown':
          exportData = content.markdown || convertHtmlToMarkdown(content.html || content);
          filename = 'content.md';
          mimeType = 'text/markdown';
          break;
        case 'json':
          exportData = JSON.stringify(content, null, 2);
          filename = 'content.json';
          mimeType = 'application/json';
          break;
        default:
          alert('Unknown format');
          return;
      }
      
      // Create download link
      const blob = new Blob([exportData], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Close modal
      document.querySelector('.modal-overlay')?.remove();
      
      showNotification(`Content exported as ${format.toUpperCase()}`, 'success');
    } catch (error) {
      console.error('Export error:', error);
      alert('Failed to export content: ' + error.message);
    }
  };
  
  // Simple HTML to Markdown converter
  function convertHtmlToMarkdown(html) {
    let markdown = html;
    
    // Headers
    markdown = markdown.replace(/<h1>(.*?)<\/h1>/gi, '# $1\n\n');
    markdown = markdown.replace(/<h2>(.*?)<\/h2>/gi, '## $1\n\n');
    markdown = markdown.replace(/<h3>(.*?)<\/h3>/gi, '### $1\n\n');
    
    // Bold and italic
    markdown = markdown.replace(/<strong>(.*?)<\/strong>/gi, '**$1**');
    markdown = markdown.replace(/<b>(.*?)<\/b>/gi, '**$1**');
    markdown = markdown.replace(/<em>(.*?)<\/em>/gi, '*$1*');
    markdown = markdown.replace(/<i>(.*?)<\/i>/gi, '*$1*');
    
    // Links
    markdown = markdown.replace(/<a href="(.*?)">(.*?)<\/a>/gi, '[$2]($1)');
    
    // Images
    markdown = markdown.replace(/<img src="(.*?)" alt="(.*?)".*?>/gi, '![$2]($1)');
    
    // Lists
    markdown = markdown.replace(/<li>(.*?)<\/li>/gi, '- $1\n');
    markdown = markdown.replace(/<ul>(.*?)<\/ul>/gis, '$1\n');
    markdown = markdown.replace(/<ol>(.*?)<\/ol>/gis, '$1\n');
    
    // Paragraphs
    markdown = markdown.replace(/<p>(.*?)<\/p>/gi, '$1\n\n');
    
    // Remove remaining HTML tags
    markdown = markdown.replace(/<[^>]+>/g, '');
    
    // Clean up extra newlines
    markdown = markdown.replace(/\n{3,}/g, '\n\n');
    
    return markdown.trim();
  }
  
  // Open template dialog
  window.openTemplateDialog = function() {
    if (!window.advancedEditor) {
      alert('Editor is still loading. Please wait a moment and try again.');
      console.log('advancedEditor not ready yet');
      return;
    }
    
    if (!window.advancedEditor.templateSystem) {
      console.warn('Template system not available, using basic templates');
    }
    
    // Create template modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    `;
    
    modalContent.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; color: #333;">Content Templates</h3>
        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">√ó</button>
      </div>
      
      <p style="color: #666; margin-bottom: 1.5rem;">Choose a template to start with:</p>
      
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <div class="template-item" onclick="applyTemplate('blog-post')" style="padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
          <h4 style="margin: 0 0 0.5rem 0; color: #333;">üìù Blog Post</h4>
          <p style="margin: 0; font-size: 0.9rem; color: #666;">Standard blog post with introduction, body, and conclusion</p>
        </div>
        
        <div class="template-item" onclick="applyTemplate('tutorial')" style="padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
          <h4 style="margin: 0 0 0.5rem 0; color: #333;">üìö Tutorial</h4>
          <p style="margin: 0; font-size: 0.9rem; color: #666;">Step-by-step tutorial with prerequisites and examples</p>
        </div>
        
        <div class="template-item" onclick="applyTemplate('review')" style="padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
          <h4 style="margin: 0 0 0.5rem 0; color: #333;">‚≠ê Product Review</h4>
          <p style="margin: 0; font-size: 0.9rem; color: #666;">Product review with pros, cons, and rating</p>
        </div>
        
        <div class="template-item" onclick="applyTemplate('news')" style="padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
          <h4 style="margin: 0 0 0.5rem 0; color: #333;">üì∞ News Article</h4>
          <p style="margin: 0; font-size: 0.9rem; color: #666;">News article with headline, summary, and details</p>
        </div>
      </div>
    `;
    
    modal.appendChild(modalContent);
    
    // Add hover effects
    const templateItems = modalContent.querySelectorAll('.template-item');
    templateItems.forEach(item => {
      item.addEventListener('mouseenter', () => {
        item.style.borderColor = '#d97706';
        item.style.backgroundColor = '#fef3c7';
      });
      item.addEventListener('mouseleave', () => {
        item.style.borderColor = '#e0e0e0';
        item.style.backgroundColor = 'transparent';
      });
    });
    
    // Close on background click
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    };
    
    document.body.appendChild(modal);
  };
  
  // Apply template
  window.applyTemplate = function(templateName) {
    const templates = {
      'blog-post': `<h2>Your Blog Post Title</h2>
<p><strong>Introduction:</strong> Start with an engaging introduction that hooks your readers...</p>

<h3>Main Content</h3>
<p>Write your main content here. Break it into sections for better readability.</p>

<h3>Key Points</h3>
<ul>
  <li>First key point</li>
  <li>Second key point</li>
  <li>Third key point</li>
</ul>

<h3>Conclusion</h3>
<p>Wrap up your post with a strong conclusion and call to action...</p>`,

      'tutorial': `<h2>Tutorial: [Your Topic]</h2>

<h3>Prerequisites</h3>
<ul>
  <li>Prerequisite 1</li>
  <li>Prerequisite 2</li>
</ul>

<h3>Step 1: [First Step]</h3>
<p>Explain the first step in detail...</p>

<h3>Step 2: [Second Step]</h3>
<p>Explain the second step...</p>

<h3>Step 3: [Third Step]</h3>
<p>Explain the third step...</p>

<h3>Conclusion</h3>
<p>Summarize what was learned and next steps...</p>`,

      'review': `<h2>Product Review: [Product Name]</h2>

<p><strong>Rating:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)</p>

<h3>Overview</h3>
<p>Brief overview of the product...</p>

<h3>Pros</h3>
<ul>
  <li>Pro 1</li>
  <li>Pro 2</li>
  <li>Pro 3</li>
</ul>

<h3>Cons</h3>
<ul>
  <li>Con 1</li>
  <li>Con 2</li>
</ul>

<h3>Final Verdict</h3>
<p>Your final thoughts and recommendation...</p>`,

      'news': `<h2>[Breaking News Headline]</h2>

<p><strong>Summary:</strong> Brief summary of the news story...</p>

<h3>Details</h3>
<p>Provide detailed information about the event...</p>

<h3>Background</h3>
<p>Give context and background information...</p>

<h3>Impact</h3>
<p>Discuss the implications and impact...</p>

<h3>What's Next</h3>
<p>Future developments and what to watch for...</p>`
    };
    
    const templateContent = templates[templateName];
    
    if (!templateContent) {
      alert('Template not found');
      return;
    }
    
    if (confirm('This will replace your current content. Continue?')) {
      if (window.advancedEditor && window.advancedEditor.setContent) {
        window.advancedEditor.setContent(templateContent);
      } else {
        // Fallback to basic editor
        const editorContent = document.getElementById('editor-content');
        if (editorContent) {
          editorContent.innerHTML = templateContent;
          window.updateContent();
        }
      }
      
      // Close modal
      document.querySelector('.modal-overlay')?.remove();
      
      showNotification('Template applied successfully', 'success');
    }
  };
  
  // Validate content
  window.validateContent = function() {
    if (!window.advancedEditor) {
      alert('Editor is still loading. Please wait a moment and try again.');
      console.log('advancedEditor not ready yet');
      return;
    }
    
    if (!window.advancedEditor.contentValidator) {
      console.warn('Content validator not available, using basic validation');
    }
    
    try {
      const content = window.advancedEditor.getContent();
      const contentHtml = content.html || content;
      
      // Basic validation checks
      const issues = [];
      const warnings = [];
      
      // Check if content is empty
      const textContent = contentHtml.replace(/<[^>]+>/g, '').trim();
      if (!textContent || textContent.length < 10) {
        issues.push('Content is too short (minimum 10 characters)');
      }
      
      // Check for broken images
      const imgMatches = contentHtml.match(/<img[^>]+src="([^"]*)"[^>]*>/gi);
      if (imgMatches) {
        imgMatches.forEach(img => {
          if (img.includes('src=""') || img.includes('src="undefined"')) {
            issues.push('Found image with missing or invalid source');
          }
        });
      }
      
      // Check for empty links
      const linkMatches = contentHtml.match(/<a[^>]+href="([^"]*)"[^>]*>(.*?)<\/a>/gi);
      if (linkMatches) {
        linkMatches.forEach(link => {
          if (link.includes('href=""') || link.includes('href="#"')) {
            warnings.push('Found link with empty or placeholder href');
          }
        });
      }
      
      // Check word count
      const wordCount = textContent.split(/\s+/).length;
      if (wordCount < 50) {
        warnings.push(`Content is quite short (${wordCount} words). Consider adding more detail.`);
      }
      
      // Show validation results
      showValidationResults(issues, warnings);
      
    } catch (error) {
      console.error('Validation error:', error);
      alert('Failed to validate content: ' + error.message);
    }
  };
  
  // Show validation results
  function showValidationResults(issues, warnings) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    `;
    
    let resultsHtml = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; color: #333;">Content Validation</h3>
        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">√ó</button>
      </div>
    `;
    
    if (issues.length === 0 && warnings.length === 0) {
      resultsHtml += `
        <div style="padding: 2rem; text-align: center;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
          <h4 style="margin: 0 0 0.5rem 0; color: #10b981;">Content looks good!</h4>
          <p style="margin: 0; color: #666;">No issues or warnings found.</p>
        </div>
      `;
    } else {
      if (issues.length > 0) {
        resultsHtml += `
          <div style="margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 1rem 0; color: #dc2626;">‚ùå Issues (${issues.length})</h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
              ${issues.map(issue => `<li style="margin-bottom: 0.5rem;">${issue}</li>`).join('')}
            </ul>
          </div>
        `;
      }
      
      if (warnings.length > 0) {
        resultsHtml += `
          <div>
            <h4 style="margin: 0 0 1rem 0; color: #f59e0b;">‚ö†Ô∏è Warnings (${warnings.length})</h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
              ${warnings.map(warning => `<li style="margin-bottom: 0.5rem;">${warning}</li>`).join('')}
            </ul>
          </div>
        `;
      }
    }
    
    modalContent.innerHTML = resultsHtml;
    modal.appendChild(modalContent);
    
    // Close on background click
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    };
    
    document.body.appendChild(modal);
  }
  
  </script>

</section>

{% endblock %}
