{% extends "base.html" %}

{% block title %}
{% if query %}Search Results for "{{ query }}"{% else %}Search{% endif %}
{% endblock %}

{% block content %}
<div class="search-page">
    <div class="search-header">
        <h1>
            {% if query %}
                Search Results for "{{ query }}"
            {% else %}
                Search
            {% endif %}
        </h1>
        
        <!-- Search Form -->
        <form method="GET" action="{{ url_for('search') }}" class="search-form">
            <div class="search-input-group">
                <input type="text" 
                       name="q" 
                       value="{{ query }}" 
                       placeholder="Search posts..." 
                       class="search-input"
                       id="search-query"
                       autocomplete="off">
                <div id="search-suggestions" class="search-suggestions"></div>
            </div>
            
            <div class="search-filters">
                <select name="category" class="search-filter">
                    <option value="">All Categories</option>
                    <option value="wealth" {% if category == 'wealth' %}selected{% endif %}>Wealth</option>
                    <option value="health" {% if category == 'health' %}selected{% endif %}>Health</option>
                    <option value="happiness" {% if category == 'happiness' %}selected{% endif %}>Happiness</option>
                </select>
                
                <button type="submit" class="search-button">Search</button>
            </div>
        </form>
    </div>
    
    {% if results %}
        <div class="search-results">
            {% if results.total_results > 0 %}
                <div class="results-info">
                    <p>Found {{ results.total_results }} result{{ 's' if results.total_results != 1 else '' }} 
                       {% if category %}in {{ category|title }}{% endif %}</p>
                </div>
                
                <div class="results-list">
                    {% for result in results.posts %}
                        <article class="search-result">
                            <h2 class="result-title">
                                <a href="{{ url_for('post_view', post_id=result.post.id) }}">
                                    {{ result.post.title }}
                                </a>
                            </h2>
                            
                            <div class="result-meta">
                                {% if result.post.category %}
                                    <span class="result-category">{{ result.post.category|title }}</span>
                                {% endif %}
                                
                                {% if result.post.published_at %}
                                    <span class="result-date">{{ result.post.published_at.strftime('%B %d, %Y') }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="result-excerpt">
                                {{ result.excerpt|safe }}
                            </div>
                            
                            {% if result.post.tags %}
                                <div class="result-tags">
                                    {% set tag_list = result.post.tags.split(',') %}
                                    {% for tag in tag_list %}
                                        <span class="tag">{{ tag.strip() }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </article>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if results.total_pages > 1 %}
                    <div class="pagination">
                        {% if results.has_prev %}
                            <a href="{{ url_for('search', q=query, category=category, page=results.page-1) }}" 
                               class="pagination-link">← Previous</a>
                        {% endif %}
                        
                        <span class="pagination-info">
                            Page {{ results.page }} of {{ results.total_pages }}
                        </span>
                        
                        {% if results.has_next %}
                            <a href="{{ url_for('search', q=query, category=category, page=results.page+1) }}" 
                               class="pagination-link">Next →</a>
                        {% endif %}
                    </div>
                {% endif %}
                
            {% else %}
                <div class="no-results">
                    <h2>No results found</h2>
                    <p>Try adjusting your search terms or removing filters.</p>
                    
                    <div class="search-suggestions-help">
                        <h3>Search Tips:</h3>
                        <ul>
                            <li>Try different keywords</li>
                            <li>Check your spelling</li>
                            <li>Use broader terms</li>
                            <li>Remove category filters</li>
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
// Search autocomplete functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-query');
    const suggestionsContainer = document.getElementById('search-suggestions');
    let debounceTimer;
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timer
        clearTimeout(debounceTimer);
        
        if (query.length < 2) {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        // Debounce the API call
        debounceTimer = setTimeout(() => {
            fetch(`{{ url_for('api_search_autocomplete') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.suggestions.length > 0) {
                        displaySuggestions(data.suggestions);
                    } else {
                        suggestionsContainer.innerHTML = '';
                        suggestionsContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching suggestions:', error);
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.style.display = 'none';
                });
        }, 300);
    });
    
    function displaySuggestions(suggestions) {
        const html = suggestions.map(suggestion => 
            `<div class="suggestion-item" data-query="${suggestion}">${suggestion}</div>`
        ).join('');
        
        suggestionsContainer.innerHTML = html;
        suggestionsContainer.style.display = 'block';
        
        // Add click handlers to suggestions
        suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', function() {
                searchInput.value = this.dataset.query;
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                searchInput.form.submit();
            });
        });
    }
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.style.display = 'none';
        }
    });
    
    // Handle keyboard navigation
    searchInput.addEventListener('keydown', function(event) {
        const suggestions = suggestionsContainer.querySelectorAll('.suggestion-item');
        const activeSuggestion = suggestionsContainer.querySelector('.suggestion-item.active');
        
        if (event.key === 'ArrowDown') {
            event.preventDefault();
            if (activeSuggestion) {
                activeSuggestion.classList.remove('active');
                const next = activeSuggestion.nextElementSibling;
                if (next) {
                    next.classList.add('active');
                } else {
                    suggestions[0].classList.add('active');
                }
            } else if (suggestions.length > 0) {
                suggestions[0].classList.add('active');
            }
        } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            if (activeSuggestion) {
                activeSuggestion.classList.remove('active');
                const prev = activeSuggestion.previousElementSibling;
                if (prev) {
                    prev.classList.add('active');
                } else {
                    suggestions[suggestions.length - 1].classList.add('active');
                }
            } else if (suggestions.length > 0) {
                suggestions[suggestions.length - 1].classList.add('active');
            }
        } else if (event.key === 'Enter') {
            if (activeSuggestion) {
                event.preventDefault();
                searchInput.value = activeSuggestion.dataset.query;
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                this.form.submit();
            }
        } else if (event.key === 'Escape') {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.style.display = 'none';
        }
    });
});
</script>
{% endblock %}